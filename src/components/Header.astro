---
import { getLangFromPath, withLangPrefix, dict } from "../i18n";

const url = new URL(Astro.request.url);
const lang = getLangFromPath(url.pathname);
const t = dict[lang];

// strip /el for switching
const pathNoLang = url.pathname.startsWith("/el")
  ? url.pathname.replace(/^\/el/, "") || "/"
  : url.pathname;

const otherLang = lang === "en" ? "el" : "en";
const switchHref = withLangPrefix(otherLang, pathNoLang);

// IMPORTANT: build links WITH language prefix
const nav = [
  { label: t.nav.home, href: withLangPrefix(lang, "/") },
  { label: t.nav.menu, href: withLangPrefix(lang, "/menu") },
  { label: t.nav.careers, href: withLangPrefix(lang, "/careers") },
  { label: t.nav.visit, href: withLangPrefix(lang, "/") + "#visit" },
];

const ctaHref = withLangPrefix(lang, "/menu");
const brandHref = withLangPrefix(lang, "/");

// language button label
const switchLabel = lang === "en" ? "Ελληνικά" : "English";
---

<header class="fixed top-0 inset-x-0 z-50">
  <div class="mx-auto max-w-6xl px-4 sm:px-6">
    <div class="mt-4 rounded-2xl border border-white/10 bg-black/40 backdrop-blur supports-[backdrop-filter]:bg-black/30">
      <div class="flex items-center justify-between gap-3 px-4 py-3">
        <!-- Brand -->
        <a href={brandHref} class="flex items-center gap-3">
          <img
            src="/logo/1-logo.png"
            alt="Sally's Bar logo"
            class="h-8 w-8 rounded-md object-contain"
            loading="eager"
          />
          <span class="text-sm font-semibold tracking-wide text-white/90">
            Sally's Bar
          </span>
        </a>

        <!-- Desktop nav -->
        <nav class="hidden md:flex items-center gap-6 text-sm text-white/75">
          {nav.map((i) => (
            <a href={i.href} class="hover:text-white transition">
              {i.label}
            </a>
          ))}
        </nav>

        <!-- Desktop right actions (Switcher + CTA) -->
        <div class="hidden md:flex items-center gap-2">
          <a
            href={switchHref}
            class="rounded-full border border-white/15 bg-white/5 px-4 py-2 text-sm text-white/90 hover:bg-white/10 transition"
            aria-label="Switch language"
          >
            {switchLabel}
          </a>

          <a
            href={ctaHref}
            class="rounded-full bg-white px-5 py-2 text-sm font-semibold text-black hover:bg-white/90 transition"
          >
            View Menu
          </a>
        </div>

        <!-- Mobile hamburger -->
        <button
          id="mobileMenuBtn"
          class="md:hidden inline-flex items-center justify-center rounded-xl border border-white/15 bg-white/5 px-3 py-2 text-sm text-white/90 hover:bg-white/10"
          aria-label="Open menu"
          aria-expanded="false"
          aria-controls="mobileMenu"
          type="button"
        >
          <span class="mr-2">Menu</span>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" class="opacity-90">
            <path d="M4 7h16M4 12h16M4 17h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>

      <!-- Mobile drawer -->
      <div id="mobileMenu" class="md:hidden hidden border-t border-white/10 px-4 py-4">
        <div class="flex flex-col gap-3 text-sm">
          <!-- Language switcher in mobile -->
          <a
            href={switchHref}
            class="rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-white/90 hover:bg-white/10"
          >
            {switchLabel}
          </a>

          {nav.map((i) => (
            <a href={i.href} class="rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-white/90 hover:bg-white/10">
              {i.label}
            </a>
          ))}

          <a
            href={ctaHref}
            class="mt-2 rounded-xl bg-white px-4 py-3 text-center text-sm font-semibold text-black hover:bg-white/90"
          >
            View Menu
          </a>
        </div>
      </div>
    </div>
  </div>

  <script is:inline>
    const btn = document.getElementById("mobileMenuBtn");
    const menu = document.getElementById("mobileMenu");

    function closeMenu() {
      if (!menu || !btn) return;
      menu.classList.add("hidden");
      btn.setAttribute("aria-expanded", "false");
    }

    btn?.addEventListener("click", () => {
      const isHidden = menu?.classList.contains("hidden");
      if (!menu) return;
      if (isHidden) {
        menu.classList.remove("hidden");
        btn.setAttribute("aria-expanded", "true");
      } else {
        closeMenu();
      }
    });

    menu?.addEventListener("click", (e) => {
      const a = e.target.closest("a");
      if (a) closeMenu();
    });
  </script>
</header>