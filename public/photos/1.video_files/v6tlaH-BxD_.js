;/*FB_PKG_DELIM*/

__d("FtsFetchEbMessagesEndFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(t,n,r,o,a,i,l){"use strict";var e=r("getFalcoLogPolicy_DO_NOT_USE")("6752"),s=o("FalcoLoggerInternal").create("fts_fetch_eb_messages_end",e),u=s;l.default=u}),98);
__d("FtsFetchEbMessagesPageEndFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(t,n,r,o,a,i,l){"use strict";var e=r("getFalcoLogPolicy_DO_NOT_USE")("6753"),s=o("FalcoLoggerInternal").create("fts_fetch_eb_messages_page_end",e),u=s;l.default=u}),98);
__d("FtsFetchEbMessagesPageStartFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(t,n,r,o,a,i,l){"use strict";var e=r("getFalcoLogPolicy_DO_NOT_USE")("6754"),s=o("FalcoLoggerInternal").create("fts_fetch_eb_messages_page_start",e),u=s;l.default=u}),98);
__d("FtsFetchEbMessagesStartFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(t,n,r,o,a,i,l){"use strict";var e=r("getFalcoLogPolicy_DO_NOT_USE")("6755"),s=o("FalcoLoggerInternal").create("fts_fetch_eb_messages_start",e),u=s;l.default=u}),98);
__d("FtsFetchOccamThreadsEndFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(t,n,r,o,a,i,l){"use strict";var e=r("getFalcoLogPolicy_DO_NOT_USE")("6776"),s=o("FalcoLoggerInternal").create("fts_fetch_occam_threads_end",e),u=s;l.default=u}),98);
__d("FtsFetchOccamThreadsPageEndFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(t,n,r,o,a,i,l){"use strict";var e=r("getFalcoLogPolicy_DO_NOT_USE")("6777"),s=o("FalcoLoggerInternal").create("fts_fetch_occam_threads_page_end",e),u=s;l.default=u}),98);
__d("FtsFetchOccamThreadsPageStartFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(t,n,r,o,a,i,l){"use strict";var e=r("getFalcoLogPolicy_DO_NOT_USE")("6778"),s=o("FalcoLoggerInternal").create("fts_fetch_occam_threads_page_start",e),u=s;l.default=u}),98);
__d("FtsFetchOccamThreadsStartFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(t,n,r,o,a,i,l){"use strict";var e=r("getFalcoLogPolicy_DO_NOT_USE")("6779"),s=o("FalcoLoggerInternal").create("fts_fetch_occam_threads_start",e),u=s;l.default=u}),98);
__d("LSFetchFtsThreads",["LSIssueNewTask"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(o){return r[0]=new t.Map,r[0].set("timestamp",e[0]),r[0].set("session_id",e[1]),r[0].set("client_caller_id",""),r[1]=t.toJSON(r[0]),t.storedProcedure(n("LSIssueNewTask"),"fts_thread_fetch",t.i64.cast([0,760]),r[1],void 0,void 0,t.i64.cast([0,0]),t.i64.cast([0,0]),void 0,void 0,t.i64.cast([0,0]),t.i64.cast([0,0]))},function(e){return t.resolve(o)}])}e.__sproc_name__="LSFTSThreadsFetchFtsThreadsStoredProcedure",e.__tables__=[],a.exports=e}),null);
__d("LSFetchFtsThreadsStoredProcedure",["LSFetchFtsThreads","LSSynchronousPromise","Promise","cr:8709"],(function(t,n,r,o,a,i,l){var e;function s(t,a){var i=t.storedProcedure(r("LSFetchFtsThreads"),a.timestamp,a.sessionId);return(e||(e=n("Promise"))).resolve(o("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(i))}l.default=s}),98);
__d("MAWAsyncEBIssueFetchAndIndexFTSQuery",["I64","MAWEBUnstoredDbMsgUtils","MAWJobDefinitions","MAWUserJidWrapper","MpsOverBridge","MpsTypes","WAJids","err"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t,n,a,i,l){i===void 0&&(i=function(){});var s=o("WAJids").threadIdForChatJid(t),u=n==null?Date.now()+6e4:Number(n);return i(),o("MpsOverBridge").mps().loadMessages({config:{persistToReverb:"no-persist",shouldFetchSupplementals:!1,shouldFetchTags:!1,shouldIgnoreLocalOnly:!0,strategy:"remote-only"},debug:{purpose:"MAWAsyncEBIssueFetchAndIndexFTSQuery_"+l},direction:"desc",from:[o("MpsTypes").toTimestamp(u),null],numMessages:(e||(e=o("I64"))).to_int32(a),threadId:o("MpsTypes").toThreadId(t)}).then(function(n){var a;if(n.success===!1)throw n.payload||r("err")(n.error);var i=n.value.messages.map(o("MAWJobDefinitions").mpsMessageToEncryptedBackupsMessage),l=n.value.cursorInfo.hasNext?(a=n.value.cursorInfo.endCursor)==null?void 0:a[0]:0;return{hasMoreAfter:n.value.cursorInfo.hasPrevious,hasMoreBefore:n.value.cursorInfo.hasNext,isPointQuery:!1,messages:o("MAWEBUnstoredDbMsgUtils").getUnstoredDbMsgFromProtobuf(i,void 0,t,o("MAWUserJidWrapper").getMyUserJid()),nextMessageTimestampMsBefore:l==null?void 0:(e||(e=o("I64"))).of_float(l),protobufMessages:i,referenceTimestamp:u.toString(),requestId:void 0,threadId:s}})}l.issueQueryAsPromise=s}),98);
__d("MAWFTSRestoreCap",["WATimeUtils","justknobx"],(function(t,n,r,o,a,i,l){"use strict";var e=r("justknobx")._("1658"),s=o("WATimeUtils").DAY_MILLISECONDS*e,u=Date.now()-s;function c(e){return e>u}l.RESTORE_CAP_DATE_MS=u,l.isRestoreTimeWithinCap=c}),98);
__d("MAWMediaGalleryBufferAndRestore",[],(function(t,n,r,o,a,i){"use strict";var e=null,l=[],s=[],u=null,c=2e3,d=10;function m(t,n,r,o,a,i,m,p,_){_==null||_.addPoint("buffer_and_restore_protobuf_start");var f=function(){l=l.concat(n),_!=null&&s.push(_),l.length>=d?(s.forEach(function(e){return e.addPoint("buffer_and_restore_protobuf_end",{string:{reason:"max_buffer_size"}})}),p(t,l,r,o,a,i,m,s),l=[],s=[]):u=window.setTimeout(function(){var e=[].concat(l),n=[].concat(s);n.forEach(function(e){return e.addPoint("buffer_and_restore_protobuf_end",{string:{reason:"timeout"}})}),p(t,e,r,o,a,i,m,n),l=[],s=[]},c)},g=function(){window.clearTimeout(u);var t=l.map(function(e){return e}),n=[].concat(s),c=e;c!=null&&(n.forEach(function(e){return e.addPoint("buffer_and_restore_protobuf_end",{string:{reason:"immediately"}})}),p(c,t,r,o,a,i,m,n)),l=[],s=[]};if(t!==e){g(),e=t,f();return}l.length===0?f():(l=l.concat(n),_!=null&&s.push(_),l.length>=d&&g())}i.bufferAndRestoreProtobuf=m}),66);
__d("MWMediaRestoreStatus",["I64","LSDatabaseSingleton","MAWChatJid"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u={mediaCount:0,messageCount:0,threadId:(e||(e=o("I64"))).zero};async function c(t,n,r){var a=await(s||(s=o("LSDatabaseSingleton"))).LSDatabaseSingleton,l=await a.runInTransaction(function(n){return o("MAWChatJid").toThreadKeyMaybeForChatJidInteger(n,(e||(e=o("I64"))).of_string(t))},"readwrite",void 0,void 0,i.id+":35");u.threadId===l?(u.messageCount+=n,u.mediaCount+=r):(u.messageCount=n,u.mediaCount=r,u.threadId=l!=null?l:(e||(e=o("I64"))).zero)}function d(){return u}l.updateRestoreStatus=c,l.getRestoreStatus=d}),98);
__d("MAWMediaGalleryRestoreSync",["CurrentUser","I64","LSDatabaseSingleton","LSIntEnum","LSMEBTaskCreationSource","LSThreadMediaGalleryGroup","MAWChatJid","MAWFTSRestoreSync","MAWHandleEchoProtobufsRestoreApi","MAWJids","MAWJobDefinitions","MAWMediaGalleryBufferAndRestore","MAWMediaGalleryEBTaggingUtils","MAWRestoreProtobufsFromEncryptedBackupsDeferred","MWMediaRestoreStatus","ReQL","WAJobOrchestratorTypes","WALogger","WAMsgType","promiseDone"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d;async function m(t,n){var a=t.hasMoreAfter,l=t.hasMoreBefore,d=t.isPointQuery,m=t.protobufMessages,_=t.referenceTimestamp,f=t.requestId,g=t.threadId;if(g==null){n==null||n.endFail("threadId is null"),o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["MediaRestore: threadId is null"])));return}n==null||n.addPoint("handle_media_restore_sync_start");var h=!o("MAWMediaGalleryEBTaggingUtils").isMediaGalleryEBTaggingRestoreEnabled();n==null||n.addPoint("get_user_jid_start");var y=o("MAWJids").toUserJid(r("CurrentUser").getAccountID());n==null||n.addPoint("get_user_jid_end"),n==null||n.addPoint("messages_decoding_and_filtering_start");var C=m.filter(function(e){var t=o("MAWHandleEchoProtobufsRestoreApi").decodeDecryptedMessageProtobuf(e,y,void 0,new Set,new Set,new Map,new Map,new Map,!0);return h&&(t.msgType===o("WAMsgType").MSG_TYPE.IMAGE||t.msgType===o("WAMsgType").MSG_TYPE.VIDEO)||t.msgType===o("WAMsgType").MSG_TYPE.DOCUMENT_FILE});n==null||n.addPoint("messages_decoding_and_filtering_end"),C.length>0&&o("MAWFTSRestoreSync").MAWGalleryEventEmitter.emit("isPersisting",!0),n==null||n.addAnnotations({int:{media_count:C.length,message_count:m.length}}),n==null||n.addPoint("update_media_restore_status_start"),await o("MWMediaRestoreStatus").updateRestoreStatus(g,m.length,C.length),n==null||n.addPoint("update_media_restore_status_end");var b=function(t,n,a,l,d,m,_,f){if(n.length===0){f.forEach(function(e){e.addPoint("restore_messages_in_worker_skipped"),e.endSuccess()});return}f.forEach(function(e){return e.addPoint("restore_messages_in_worker_start",{int:{protobuf_msg_count:n.length}})}),r("promiseDone")(o("MAWRestoreProtobufsFromEncryptedBackupsDeferred").call("AdvancedCrypto",o("MAWJobDefinitions").toThreadJidPrimaryId(t),n,a,void 0,l,void 0,d,m,_,void 0,void 0,(u||(u=o("I64"))).of_int32(r("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE),o("WAJobOrchestratorTypes").JOB_PRIORITY.LOW,void 0).catch(function(e){f.forEach(function(t){return t.endFail(e)}),o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["MediaRestore Protobuf error: ",""])),e)}),function(){f.forEach(function(e){return e.addPoint("restore_messages_in_worker_end")}),f.forEach(function(e){return e.addPoint("restore_messages_update_ranges_start")}),r("promiseDone")((c||(c=o("LSDatabaseSingleton"))).LSDatabaseSingleton.then(async function(e){f.forEach(function(e){return e.addPoint("update_range_get_thread_key_start")});var t=await e.runInTransaction(function(e){return o("MAWChatJid").toThreadKeyMaybeForChatJidInteger(e,(u||(u=o("I64"))).of_string(g))},"readonly",void 0,void 0,i.id+":188");if(f.forEach(function(e){return e.addPoint("update_range_get_thread_key_end")}),t==null){f.forEach(function(e){return e.addPoint("restore_messages_update_ranges_end",{bool:{is_updated:!1}})});return}return Promise.all([p(e,t,r("LSThreadMediaGalleryGroup").PHOTOS_AND_VIDEOS),p(e,t,r("LSThreadMediaGalleryGroup").FILES_ONLY)])}).then(function(){o("MAWFTSRestoreSync").MAWGalleryEventEmitter.emit("isPersisting",!1),f.forEach(function(e){return e.addPoint("restore_messages_update_ranges_end",{bool:{is_updated:!0}})}),f.forEach(function(e){return e.addPoint("handle_media_restore_sync_end")}),f.forEach(function(e){return e.endSuccess()})}))})};o("MAWMediaGalleryBufferAndRestore").bufferAndRestoreProtobuf(g,C,l,a,d,f,_,b,n)}function p(e,t,n){return o("MAWMediaGalleryEBTaggingUtils").isMediaGalleryEBTaggingRestoreEnabled()&&o("MAWMediaGalleryEBTaggingUtils").isMediaGalleryGroupSupportedForTaggedRestore(n)?Promise.resolve():e.runInTransaction(async function(r){var a=await o("ReQL").firstAsync(o("ReQL").fromTableAscending(e.tables.attachments_ranges_v2__generated).getKeyRange(t).filter(function(e){return(u||(u=o("I64"))).equal(e.mediaGroup,(d||(d=o("LSIntEnum"))).ofNumber(n))}));if(!(a==null||(a==null?void 0:a.hasMoreBefore)===!0)){var i=babelHelpers.extends({},a,{hasMoreBefore:!0});return r.attachments_ranges_v2__generated.upsert([a.threadKey,a.mediaGroup,a.minTimestampMs],i)}},"readwrite","ui",void 0,i.id+":262")}l.handleMediaRestoreSync=m}),98);
__d("MAWFTSRestoreSyncLogger",["FtsFetchEbMessagesEndFalcoEvent","FtsFetchEbMessagesPageEndFalcoEvent","FtsFetchEbMessagesPageStartFalcoEvent","FtsFetchEbMessagesStartFalcoEvent","FtsFetchOccamThreadsEndFalcoEvent","FtsFetchOccamThreadsPageEndFalcoEvent","FtsFetchOccamThreadsPageStartFalcoEvent","FtsFetchOccamThreadsStartFalcoEvent","MAWBridgeSendAndReceive"],(function(t,n,r,o,a,i,l){"use strict";var e=new Set,s=new Set,u=null,c=!1,d=0,m=0;async function p(){u!=null&&u!==""||(u=await o("MAWBridgeSendAndReceive").sendAndReceive("backend","searchGetFTSRestoreSessionId"))}function _(t,n,o){if(!n||s.has(t)){s.add(t);return}e.has(t)||(e.add(t),o&&r("FtsFetchEbMessagesStartFalcoEvent").log(function(){return{app_name:"",session_id:u!=null?u:""}})),r("FtsFetchEbMessagesPageStartFalcoEvent").log(function(){return{app_name:"",session_id:u!=null?u:""}})}function f(t,n,o){s.has(t)||!e.has(t)||(r("FtsFetchEbMessagesPageEndFalcoEvent").log(function(){return{app_name:"",messages_count:n.toString(),session_id:u!=null?u:""}}),o||(s.add(t),r("FtsFetchEbMessagesEndFalcoEvent").log(function(){return{app_name:"",duration:0,session_id:u!=null?u:"",total_messages_count:"0"}})))}function g(t){s.has(t)||!e.has(t)||r("FtsFetchEbMessagesPageEndFalcoEvent").log(function(){return{app_name:"",messages_count:"0",session_id:u!=null?u:""}})}function h(){r("FtsFetchOccamThreadsEndFalcoEvent").log(function(){return{app_name:"",duration:0,remaining_threads_count:m.toString(),session_id:u!=null?u:"",total_threads_count:d.toString()}})}function y(){c||(c=!0,r("FtsFetchOccamThreadsStartFalcoEvent").log(function(){return{app_name:"",session_id:u!=null?u:""}})),r("FtsFetchOccamThreadsPageStartFalcoEvent").log(function(){return{app_name:"",session_id:u!=null?u:""}})}function C(e){r("FtsFetchOccamThreadsPageEndFalcoEvent").log(function(){return{app_name:"",session_id:u!=null?u:"",thread_count:e.toString()}})}function b(e){d++,e||m++}l.initLoggingSessionId=p,l.onFetchMessagePageStart=_,l.onFetchMessagePageComplete=f,l.onFetchMessagePageFailed=g,l.onFetchThreadsComplete=h,l.onFetchThreadsPageStart=y,l.onFetchThreadsPageComplete=C,l.incrementTotalResultCount=b}),98);
__d("MWEncryptedBackUpEBNotEnabledError",[],(function(t,n,r,o,a,i){"use strict";var e="EB not enabled";i.EB_NOT_ENABLED=e}),66);
__d("MWMediaRestoreQplUtils",["QPLFlow","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e=18e4;function s(){var t=r("qpl")._(25304794,"2287");return o("QPLFlow").startQPLFlow(t,{timeoutInMs:e})}function u(){var t=r("qpl")._(25306381,"2492");return o("QPLFlow").startQPLFlow(t,{timeoutInMs:e})}l.startMediaRestoreBatchQPLFlow=s,l.startMediaRestoreLoadAllQPLFlow=u}),98);
__d("MAWFTSRestoreSync",["EventEmitter","FBLogger","I64","LSDatabaseSingleton","MAWAsyncEBIssueFetchAndIndexFTSQuery","MAWBridgeFireAndForget","MAWBridgeSearchMsg","MAWBridgeSendAndReceive","MAWDbMsg","MAWFTSIsMessageValidForSearch","MAWFTSRestoreCap","MAWFTSRestoreSyncLogger","MAWMediaGalleryRestoreSync","MWEncryptedBackUpEBNotEnabledError","MWMediaRestoreQplUtils","QPLFlow","WAPromiseDelays","cr:19810","err","getErrorSafe","isEbEnabledWithIGDEligibilityCheck","justknobx","qpl","uuidv4"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=new(r("EventEmitter")),c=(e||(e=o("I64"))).of_int32(r("justknobx")._("2477")),d=r("justknobx")._("2606"),m=r("uuidv4")();function p(e){return new Promise(function(t,n){return globalThis.setTimeout(function(){return n(r("err")("timeout"))},e)})}function _(){window.setInterval(function(){o("MAWBridgeFireAndForget").fireAndForget("backend","searchFTSReportTabAlive",{hasFocus:document.hasFocus(),tabId:m},!0)},1e3)}async function f(e){await o("MAWBridgeSendAndReceive").sendAndReceive("backend","searchFTSReportTabTaskComplete",{error:e,tabId:m})}async function g(){await o("MAWBridgeSendAndReceive").sendAndReceive("backend","searchFTSReportTabDestroy",{tabId:m})}function h(e){var t=200,n=12e4;return Math.min(t*Math.pow(3,e),n)}var y=(function(){function t(e){e===void 0&&(e="search"),this.$1=!1,this.$2=!0,this.$3=!1,this.$4=!0,this.$5=void 0,this.$6={},this.$7=new Set,this.$8=new Set,this.$9=new Set,this.$10=e,r("FBLogger")("fts_worker").info("New MAWFTSRestoreSync instance: "+e)}var a=t.prototype;return a.setIsStarted=function(t){this.$1=t,this.$10==="media"&&u.emit("isSyncStarted",t)},a.setIsEBMaybeAvailable=function(t){this.$4=t,this.$10==="media"&&u.emit("isEBMaybeAvailable",t)},a.setActiveThreadId=function(t,r){r===void 0&&(r=!0),n("cr:19810")!=null&&r&&t!=null&&n("cr:19810").getInstance().insertIntoHead(t),this.$5=t,this.$10==="media"&&u.emit("activeThreadJid",t)},a.setShouldPauseRestore=function(t){this.$3=t},a.removeFromQueue=function(t){n("cr:19810")!=null&&t!=null&&n("cr:19810").getInstance().removeThread(t)},a.getActiveThreadId=function(){return this.$5},a.getNextThreadIdToFetch=function(){if(n("cr:19810")!=null){var e;return(e=n("cr:19810").getInstance().getThreadsHead())!=null?e:this.getActiveThreadId()}return this.getActiveThreadId()},a.getDoneThreads=function(){return this.$7},a.getDoneThreadsAfterReset=function(){return this.$9},a.getResetThreads=function(){return this.$8},a.isStarted=function(){return this.$1},a.isEBMaybeAvailable=function(){return this.$4},a.resetEBAvailability=function(){this.setIsEBMaybeAvailable(!0)},a.resetRestoreStatus=function(){var e=this,t=this.getActiveThreadId();return t!=null&&!this.$8.has(t)?o("MAWBridgeSendAndReceive").sendAndReceive("backend","searchFTSClearThreadRestoreStatus",{threadId:t},{isLoggingDisabled:!0}).then(function(){e.$8.add(t)}):Promise.resolve()},a.$11=function(t,n){var e=this;Object.keys(this.$6).forEach(function(r){e.$6[r](t,n)})},a.$12=function(t,r,a){return t!==r&&n("cr:19810")!=null?a==null||o("MAWFTSRestoreCap").isRestoreTimeWithinCap(parseInt(a,10)):a!=="0"},a.$13=async function(){this.setIsStarted(!0),this.setShouldPauseRestore(!1),await o("MAWBridgeSendAndReceive").sendAndReceive("backend","searchFTSReportTabForeground",{tabId:m},{isLoggingDisabled:!0}),window.addEventListener("focus",async function(){await o("MAWBridgeSendAndReceive").sendAndReceive("backend","searchFTSReportTabForeground",{tabId:m},{isLoggingDisabled:!0})}),_()},a.shouldLoop=async function(t){if(this.$1||this.$4===!1)return!1;await this.$13();var e=await o("isEbEnabledWithIGDEligibilityCheck").isEbEnabledWithIGDEligibilityCheck(t);return e?!0:(this.setIsEBMaybeAvailable(!1),this.setIsStarted(!1),!1)},a.loadMessages=async function(n,a,i,l,s,u,_){var t=await o("MAWBridgeSendAndReceive").sendAndReceive("backend","searchFTSRequestRestoreTask",{tabId:m,threadJid:n});if(!t)return await o("WAPromiseDelays").delayMs(200),"CONTINUE";var h=o("MAWAsyncEBIssueFetchAndIndexFTSQuery").issueQueryAsPromise(n,a,c,i,u);if(h==null)return this.setIsEBMaybeAvailable(!1),this.setIsStarted(!1),"STOP";var y=s();y.addAnnotations({int:{retryCount:l},string:{restoreUntilMs:a!=null?a:""}});try{var C=function(){return Promise.race([h,p(d)])},b=await o("QPLFlow").QplSubspan.wrapInSubspan(y,"fetch_request",C),v=b.nextMessageTimestampMsBefore!=null?(e||(e=o("I64"))).to_int32(b.nextMessageTimestampMsBefore):void 0,S=Number(a)===v;return y.addAnnotations({bool:{paginationStuck:S},int:{numMessages:b.messages.length}}),await o("QPLFlow").QplSubspan.wrapInSubspan(y,"process_data",function(){return _(b,y)}),y.endSuccess(),await f(),"CONTINUE"}catch(e){var R,L=r("getErrorSafe")(e);return L&&L.message===o("MWEncryptedBackUpEBNotEnabledError").EB_NOT_ENABLED?(y.addPoint("eb_not_enabled"),y.endCancel(),this.setIsEBMaybeAvailable(!1),this.setIsStarted(!1),await g(),"STOP"):(L.message==="invalid-client-state"||(r("FBLogger")("fts_worker").catching(L).mustfix("Fail to fetch a new batch of messages"),y.endFail((R=L.message)!=null?R:"unknown"),await f(L)),"FAIL")}},a.startSyncingLoop=async function(){var t=this;this.setShouldPauseRestore(!1);var a=await(s||(s=o("LSDatabaseSingleton"))).LSDatabaseSingleton;if(await this.shouldLoop(a)){await o("MAWFTSRestoreSyncLogger").initLoggingSessionId();for(var i=0,l=null,u=async function(){var a,s=t.getNextThreadIdToFetch(),u=t.getActiveThreadId();if(l!==s&&(l=s,i=0),s==null||n("cr:19810")==null&&t.$7.has(s))return await o("WAPromiseDelays").delayMs(200),0;if(t.$3)return await o("WAPromiseDelays").delayMs(200),0;var c=await o("MAWBridgeSendAndReceive").sendAndReceive("backend","searchFTSGetThreadRestoreStatus",{threadId:s},{isLoggingDisabled:!0}),d=(a=c==null?void 0:c.restoredUntilSortOrderMs)!=null?a:null,m=c==null||c.restoredUntilSortOrderMs===c.maxRestoredUntilSortOrderMs||c.restoredUntilSortOrderMs==null,p=t.$12(s,u,d);if(!p)return d==="0"&&(t.$7.add(s),t.$8.has(s)&&t.$9.add(s)),t.removeFromQueue(s),await o("WAPromiseDelays").delayMs(200),0;var _=await t.loadMessages(s,d,function(){o("MAWFTSRestoreSyncLogger").onFetchMessagePageStart(s,d==null||o("MAWFTSRestoreCap").isRestoreTimeWithinCap(parseInt(d,10)),m)},i,function(){return o("QPLFlow").startQPLFlow(r("qpl")._(25300854,"2397"))},"fts",async function(n){var r=n.messages,a=n.nextMessageTimestampMsBefore,i=a!=null?(e||(e=o("I64"))).to_string(a):"0",l=o("MAWFTSRestoreCap").isRestoreTimeWithinCap(parseInt(i,10));o("MAWFTSRestoreSyncLogger").onFetchMessagePageComplete(s,r.length,l),t.$11(s,r);var u=r.map(function(e){var t=o("MAWFTSIsMessageValidForSearch").verifyMessageValidity(e);return t==null?null:o("MAWBridgeSearchMsg").createBridgeSearchMsg(babelHelpers.extends({author:e.author,canonicalTs:o("MAWDbMsg").getCanonicalTsFromMsg(e),externalId:e.externalId,threadJid:s},t),!1)}).filter(Boolean);await o("MAWBridgeSendAndReceive").sendAndReceive("backend","searchIndexUpdate",{newSortOrderMs:i,threadId:s,unvaultedBridgeSearchMessages:u})});e:{if(_==="CONTINUE"){i=0;break e}if(_==="FAIL"){o("MAWFTSRestoreSyncLogger").onFetchMessagePageFailed(s),await o("WAPromiseDelays").delayMs(h(i)),i++;break e}if(_==="STOP")return{v:void 0};throw Error("Match: No case succesfully matched. Make exhaustive or add a wildcard case using '_'. Argument: "+_)}},c;this.$2;)if(c=await u(),c!==0&&c)return c.v}},a.startMediaSyncingLoop=async function(){var t=this,n=await(s||(s=o("LSDatabaseSingleton"))).LSDatabaseSingleton;if(await this.shouldLoop(n)){for(var r=0,a=async function(){var n,a=t.getActiveThreadId();if(a==null||t.$7.has(a))return await o("WAPromiseDelays").delayMs(200),0;if(t.$3)return await o("WAPromiseDelays").delayMs(200),0;var i=await o("MAWBridgeSendAndReceive").sendAndReceive("backend","getThreadMediaRestoreStatus",{threadId:a},{isLoggingDisabled:!0}),l=(n=i==null?void 0:i.restoredUntilSortOrderMs)!=null?n:null;u.emit("restoredUntilMs",l!=null?parseInt(l,10):-1);var s=t.$12(a,a,l);if(!s)return l==="0"&&t.$7.add(a),await o("WAPromiseDelays").delayMs(200),0;var c=await t.loadMessages(a,l,void 0,r,o("MWMediaRestoreQplUtils").startMediaRestoreBatchQPLFlow,"media",async function(t,n){var r=t.nextMessageTimestampMsBefore!=null?(e||(e=o("I64"))).to_string(t.nextMessageTimestampMsBefore):"0";await o("MAWMediaGalleryRestoreSync").handleMediaRestoreSync(t,n),await o("MAWBridgeSendAndReceive").sendAndReceive("backend","setThreadMediaRestoreStatus",{newSortOrderMs:r,threadId:a},{isLoggingDisabled:!0})});e:{if(c==="CONTINUE"){r=0;break e}if(c==="FAIL"){await o("WAPromiseDelays").delayMs(h(r)),r++;break e}if(c==="STOP")return{v:void 0};throw Error("Match: No case succesfully matched. Make exhaustive or add a wildcard case using '_'. Argument: "+c)}},i;this.$2;)if(i=await a(),i!==0&&i)return i.v}},t.getInstance=function(){var e=t.instance;if(e!=null)return e;var n=new t;return t.instance=n,n},t.getMediaInstance=function(){var e=t.mediaInstance;if(e!=null)return e;var n=new t("media");return t.mediaInstance=n,n},t.resetInstance=function(){t.instance=null},a.setKeepWhileLoop_FOR_TESTING_ONLY=function(t){this.$2=t},t})();y.instance=null,y.mediaInstance=null;function C(){return y.getInstance()}function b(){return y.getMediaInstance()}l.MAWGalleryEventEmitter=u,l.MAWFTSRestoreSync=y,l.getFTSRestoreSync=C,l.getMediaRestoreSync=b}),98);
__d("ThreadsDoublyLinkedList",[],(function(t,n,r,o,a,i){"use strict";var e=function(t){this.value=t},l=(function(){function t(){this.$1=new Map,this.$2=null,this.$3=null}var n=t.prototype;return n.getHead=function(){if(this.$2!=null)return this.$2.value},n.has=function(t){return this.$1.has(t)},n.size=function(){return this.$1.size},n.insertToHead=function(n){this.getHead()!==n&&(this.has(n)&&this.remove(n),this.$2==null?this.add(n):(this.$2.prev=new e(n),this.$2.prev.next=this.$2,this.$2=this.$2.prev,this.$1.set(n,this.$2)))},n.add=function(n){if(!this.has(n)){if(!this.$2){this.$2=new e(n),this.$3=this.$2,this.$1.set(n,this.$2);return}this.$3!=null&&(this.$3.next=new e(n),this.$3.next.prev=this.$3,this.$3=this.$3.next,this.$1.set(n,this.$3))}},n.remove=function(t){var e=this.$1.get(t);e!=null&&(e.prev!=null&&(e.prev.next=e.next),e.next!=null&&(e.next.prev=e.prev),e===this.$2&&(this.$2=e.next),e===this.$3&&(this.$3=e.prev),this.$1.delete(t))},t})();i.default=l}),66);
__d("MAWFTSThreadsRestore",["FBLogger","I64","LSDatabaseSingleton","LSFactory","LSFetchFtsThreadsStoredProcedure","LSMessagingThreadTypeUtil","MAWBridgeSendAndReceive","MAWFTSRestoreCap","MAWFTSRestoreSyncLogger","MAWJids","ReQL","ThreadsDoublyLinkedList","WAJids","emptyFunction","promiseDone"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c=(function(){function t(){this.$1=new Map,this.$4=!1,this.$5=(e||(e=o("I64"))).zero,this.$6=!1,this.$7=new Set,r("FBLogger")("messenger_web").info("New MAWFTSThreadsRestore instance"),this.$2=new(r("ThreadsDoublyLinkedList"))}var n=t.prototype;return n.startThreadsRestore=async function(){this.$4||(this.$4=!0,this.$6=!0,await o("MAWFTSRestoreSyncLogger").initLoggingSessionId(),await this.$8(),await this.$9())},n.isThreadQueryInProgress=function(){return this.$6||this.$7.size>0},n.getInitialLastActivityTimeForThreadMs=function(t){return this.$1.get(t)},n.getThreadsHead=function(){return this.$2.getHead()},n.hasThread=function(t){return this.$2.has(t)},n.insertIntoHead=function(t){this.$2.insertToHead(t)},n.removeThread=function(t){this.$2.remove(t)},n.$10=function(t,n){o("MAWFTSRestoreSyncLogger").onFetchThreadsPageStart(),t.runInTransaction(function(e){return r("LSFetchFtsThreadsStoredProcedure")(r("LSFactory")(e),{sessionId:"",timestamp:n})},"readwrite",void 0,void 0,i.id+":123")},n.$11=function(n,a,i){i===void 0&&(i=r("emptyFunction")),this.$6=!0;var t=a.hasNextPage,l=a.nextPageCursor,s=a.resultCount,u=(e||(e=o("I64"))).to_int32(s),c=!e.equal(l,this.$5),d=o("MAWFTSRestoreCap").isRestoreTimeWithinCap(e.to_float(l));c&&o("MAWFTSRestoreSyncLogger").onFetchThreadsPageComplete(u),t&&d?c&&(this.$5=l,this.$10(n,l)):(this.$6=!1,this.$7.size===0&&o("MAWFTSRestoreSyncLogger").onFetchThreadsComplete(),i())},n.$8=async function(){var t=this,n=await this.$12(),r=o("ReQL").fromTableAscending(n.tables.messenger_fts_threads_queries,["hasNextPage","nextPageCursor","resultCount"]),a={contents:function(){}};a.contents=r.subscribe(function(e,r){r.operation!=="delete"&&t.$11(n,r.value,a.contents)});var i=await o("ReQL").firstAsync(r);i?this.$11(n,i):this.$10(n,(e||(e=o("I64"))).max_int)},n.$13=function(n){var t=this,a=n.nextMessageTimestamp,i=n.threadId,l=n.threadType,s=(e||(e=o("I64"))).to_string(i),u=o("LSMessagingThreadTypeUtil").isGroup(l),c=u?o("WAJids").toGroupJid(s):o("MAWJids").toUserJid(s);this.$7.add(c),r("promiseDone")(o("MAWBridgeSendAndReceive").sendAndReceive("backend","searchGetFTSNextTimestamp",{threadId:c}).then(function(n){var r=(e||(e=o("I64"))).to_float(a);if(o("MAWFTSRestoreCap").isRestoreTimeWithinCap(r)){if(!t.$1.has(c)){t.$1.set(c,r);var i=n!=null&&!o("MAWFTSRestoreCap").isRestoreTimeWithinCap(parseInt(n,10));o("MAWFTSRestoreSyncLogger").incrementTotalResultCount(i)}if(n!=="0")return t.$2.add(o("WAJids").unsafeCoerceToChatJid(c)),o("MAWBridgeSendAndReceive").sendAndReceive("backend","searchSetFTSNextTimestamp",{newSortOrderMs:e.to_string(a),threadId:c})}}).finally(function(){t.$7.delete(c),t.$7.size===0&&!t.$6&&o("MAWFTSRestoreSyncLogger").onFetchThreadsComplete()}))},n.$9=async function(){var e=this,t=await this.$12(),n=o("ReQL").fromTableAscending(t.tables.messenger_fts_threads,["threadId","nextMessageTimestamp","threadType"]);n.subscribe(function(t,n){n.operation==="add"&&e.$13(n.value)});var r=await o("ReQL").toArrayAsync(n);r.forEach(function(t){e.$13(t)})},n.$12=async function(){return this.$3==null&&(this.$3=await(s||(s=o("LSDatabaseSingleton"))).LSDatabaseSingleton),this.$3},t})();function d(){return u==null&&(u=new c),u}l.MAWFTSThreadsRestore=c,l.getInstance=d}),98);